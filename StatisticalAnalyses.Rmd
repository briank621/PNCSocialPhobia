---
title: "StatisticalAnalyses"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("brainGraph")
library("data.table")
library("MKinfer")
```

## Load Data

```{r}
savedir = "/home/xin/BrainImaging2016/Brian/savedGraphs"
A.all.norm.sub = readRDS(file.path(savedir,'GAAL.A.all.norm.sub.rds'))
```


## Check Covariates

Check if sex / age are significantly different in two groups

### Sex

```{r}
spSex = ifelse(covars.fmri[status=='Control']$Sex=="F", 0, 1)
controlSex = ifelse(covars.fmri[status=='SPADHD']$Sex == "F", 0, 1)
perm.t.test(spSex, controlSex, R = 10000) # two sample t-test (SP, Control)
```
### Age

```{r}
spAge = as.numeric(covars.fmri[status=='Control']$age_at_cnb)
controlAge = as.numeric(covars.fmri[status=='SPADHD']$age_at_cnb)
perm.t.test(spSex, controlSex, R = 10000) # two sample t-test (SP, Control)
```

## Two Sample T Test for all connections

Two sample t-test on all possible connections to see which functional connections are significantly disrupted. The data is run on the raw values.

**This code takes very long to run (several hours). You can load the pvalues in the block after this.**

```{r}
source("ComputeFC.R")
fcResults = list()
for(i in 1:length(groupings)){
    controlGroup = allControls[[i]]
    experimentalGroup = allExperimental[[i]]
    pvalues = computeFC(A.pos.norm.sub, controlGroup, experimentalGroup, 116, aal116)
    adjustedPValues = p.adjust(pvalues$p.value, "fdr")
    significantPValues = pvalues[which(adjustedPValues < .05)]
    uncorrected = pvalues[p.value < .001]
    fcResults[[i]] = list("significantPValues"=significantPValues, "uncorrected"=uncorrected, "pvalues"=pvalues)
}

```

Loading the Data from saved RDS

```{r}
saveRDS(fcResults, file=file.path(savedir, 'AAL.fcResults.rds'), compress='xz')
#saveRDS(pvalues, file=file.path(savedir, 'AAL.ALLSP.p.values.rds'), compress='xz')
#saveRDS(pvalues, file=file.path(savedir, 'AAL.PureSP.p.values.rds'), compress='xz')
#saveRDS(pvalues, file=file.path(savedir, 'AAL.ADHDControl.p.values.rds'), compress='xz')
saveRDS(pvalues, file=file.path(savedir, 'AAL.SPADHD.p.values.rds'), compress='xz')

fcResults = readRDS(file.path(savedir, 'GAAL.fcResults.rds'))
pvalues = readRDS(file.path(savedir,'ALLSP.p.values.rds'))
pvalues = readRDS(file.path(savedir,'PureSP.p.values.rds'))
pvalues = readRDS(file.path(savedir,'ADHDControl.p.values.rds'))
pvalues = readRDS(file.path(savedir,'SPADHD.p.values.rds'))


uncorrected = pvalues[p.value < .001]
```


### Identify Significant Pairings

We will do a FDR (Benjamini Hochberg) correction

```{r}
adjustedPValues = p.adjust(pvalues$p.value, "fdr")
pvalues[which(adjustedPValues < .05)]
```


The middle of each confidence interval is extracted to be used as edge weights when backprojecting the edges on BrainNetViewer.

```{r}
extractConfidence = function(row, A.pos.norm.sub, controlGroup, experimentalGroup){
    i = row$region1Index
    j = row$region2Index
    spCount = 1
    controlCount = 1
    numSP = length(experimentalGroup)
    numControl = length(controlGroup)
    spList = rep(0, numSP)
    controlList = rep(0, numControl)
    n = dim(A.pos.norm.sub[[1]])[3]
    for(subject in 1:n){i
        if(is.element(subject, controlGroup)){
            controlList[controlCount] = A.pos.norm.sub[[1]][i,j,subject]
            controlCount = controlCount + 1
        }
        else if(is.element(subject, experimentalGroup)){
            spList[spCount] = A.pos.norm.sub[[1]][i,j,subject]
            spCount = spCount + 1
        }
    }     
    ttest = perm.t.test(spList, controlList, R = 10000)
    return ((ttest$perm.conf.int[1] + ttest$perm.conf.int[2]) / 2)
}
```

```{r}
attachConfInt = function(fc.dt, controlGroup, experimentalGroup){
    numEdges = NROW(fc.dt)
    confInt = by(fc.dt, seq_len(nrow(fc.dt)), extractConfidence, A.pos.norm.sub, controlGroup, experimentalGroup)
    fc.dt = cbind(fc.dt, confInt)
}
```

Adding a confidence interval column for each of the edges identified by FC differences
```{r}
for(i in 1:length(fcResults)){
    controlGroup = allControls[[i]]
    experimentalGroup = allExperimental[[i]]
    numEdges = NROW(fcResults[[i]]$significantPValues)
    confInt = rep(NA, numEdges)
    if(numEdges != 0){
        for(j in 1:numEdges){
            confInt[j] = extractConfidence(fcResults[[i]]$significantPValues[j], A.all.norm.sub, controlGroup, experimentalGroup)
        }
        
        fcResults[[i]]$significantPValues = cbind(fcResults[[i]]$significantPValues, confInt)
    }
    
    numEdges = NROW(fcResults[[i]]$uncorrected)
    confInt = rep(NA, numEdges)
    print(i)
    if(numEdges != 0){
        for(j in 1:numEdges){
            confInt[j] = extractConfidence(fcResults[[i]]$uncorrected[j], A.all.norm.sub, controlGroup, experimentalGroup)
        }
        fcResults[[i]]$uncorrected = cbind(fcResults[[i]]$uncorrected, confInt)
    }
}
```

Adding a confidence interval column for each of the edges identified by seed result differences
```{r}
for(i in 1:length(seedResults)){
    controlGroup = allControls[[i]]
    experimentalGroup = allExperimental[[i]]
    
    for(j in 1:length(seedResults[[i]])){
        numEdges = NROW(seedResults[[i]][[j]]$significantPValues)
        confInt = rep(NA, numEdges)
        if(numEdges != 0){
            for(k in 1:numEdges){
                confInt[j] = extractConfidence(seedResults[[i]][[j]]$significantPValues[k], A.all.norm.sub, controlGroup, experimentalGroup)
            }
            seedResults[[i]][[j]]$significantPValues = cbind(seedResults[[i]][[j]]$significantPValues, confInt)
        }
    }
}
```


## Two Sample T-Test for Seed Regions (NOT USED CURRENTLY)

```{r}
source("ComputeFCSeed.R")
seedResults = list()
# Seed regions are L/R Amygdala, L/R dACC, L/R pCC
seedRegions = c(41, 42, 31, 32, 35, 36)
for(i in 1:length(groupings)){
    controlGroup = allControls[[i]]
    experimentalGroup = allExperimental[[i]]
    roiResults = list()
    index = 1
    for(roi in seedRegions){
        pvalues = computeFCSeed(A.pos.norm.sub, roi, controlGroup, experimentalGroup, 116, aal116)
        adjustedPValues = p.adjust(pvalues$p.value, "fdr")
        significantPValues = pvalues[which(adjustedPValues < .05)]
        roiResults[[index]] = list("significantPValues"=significantPValues, "pvalues"=pvalues)
        index = index + 1
    }
    seedResults[[i]] = roiResults
}

```

```{r}

#saveRDS(seedResults, file=file.path(savedir, 'AAL.seedResults.rds'), compress='xz')
#A.all.norm.sub = readRDS(file.path(savedir,'AAL.all.norm.sub.rds'))
#A.pos.norm.sub = readRDS(file.path(savedir,'AAL.A.pos.norm.sub.rds'))
#saveRDS(fcResults, file=file.path(savedir, 'GAAL.fcResults.rds'), compress='xz')
#saveRDS(seedResults, file=file.path(savedir, 'GAAL.seedResults.rds'), compress='xz')
seedResults = readRDS(file.path(savedir, 'GAALMotion.seedResults.rds'))
fcResults = readRDS(file.path(savedir, 'GAALMotion.fcResults.rds'))
```



